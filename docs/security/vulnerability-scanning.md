# Vulnerability Scanning

The VPS Configurator includes integrated vulnerability scanning using industry-standard tools **Trivy** and **Grype**. This module automatically detects CVEs in installed system packages and Docker containers.

## Overview

The vulnerability scanning system provides:

- **System Package Scanning**: Detect CVEs in installed Debian packages
- **Docker Image Scanning**: Scan all local Docker images for vulnerabilities
- **Auto-Remediation**: Automatically upgrade vulnerable packages
- **Continuous Monitoring**: Schedule regular vulnerability scans
- **Rich Reporting**: Generate HTML and JSON vulnerability reports

## Prerequisites

Install at least one of the supported scanners:

### Trivy (Recommended)

```bash
# Add repository
sudo apt-get install -y wget apt-transport-https gnupg lsb-release
wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list

# Install
sudo apt-get update
sudo apt-get install -y trivy
```

### Grype

```bash
curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
```

## CLI Usage

### Scan System Packages

```bash
vps-configurator vuln scan --target system
```

### Scan Docker Images

```bash
vps-configurator vuln scan --target docker
```

### Scan Everything

```bash
vps-configurator vuln scan --target all --format html json
```

### Auto-Remediate Vulnerabilities

```bash
vps-configurator vuln scan --target system --auto-remediate
```

### Start Continuous Monitoring

```bash
vps-configurator vuln monitor --interval 24 --auto-remediate
```

## Configuration

Configure vulnerability scanning in `config/default.yaml`:

```yaml
vulnerability_scanning:
  enabled: true
  preferred_scanner: trivy  # trivy or grype
  scan_targets:
    system: true
    docker_images: true
  auto_remediate:
    enabled: false
    severity_threshold: high  # critical, high, medium, low
  monitoring:
    enabled: false
    interval_hours: 24
  reporting:
    format: [html, json]
    output_dir: reports/vulnerability
```

## Data Models

### Vulnerability

Represents a single CVE detection:

| Field | Type | Description |
|-------|------|-------------|
| `cve_id` | str | CVE identifier (e.g., CVE-2024-1234) |
| `package_name` | str | Affected package name |
| `installed_version` | str | Currently installed version |
| `fixed_version` | str | Version with fix (if available) |
| `severity` | enum | CRITICAL, HIGH, MEDIUM, LOW, UNKNOWN |
| `cvss_score` | float | CVSS score (0-10) |
| `description` | str | Vulnerability description |
| `exploit_available` | bool | Whether public exploit exists |

### ScanResult

Aggregated result from a single scan:

| Field | Type | Description |
|-------|------|-------------|
| `scan_id` | str | Unique scan identifier |
| `scan_date` | datetime | When scan was performed |
| `scanner_name` | str | Scanner used (Trivy/Grype) |
| `target` | str | What was scanned |
| `vulnerabilities` | list | List of Vulnerability objects |
| `scan_duration_seconds` | float | Time taken for scan |

## Report Generation

Reports are generated automatically after scans:

- **HTML Report**: Interactive web page with severity breakdown, filtering, and CVE links
- **JSON Report**: Machine-readable format for integration with other tools

Reports are saved to `reports/vulnerability/` by default.

## Architecture

```
configurator/security/
├── vulnerability_scanner.py   # Core scanner implementation
│   ├── Vulnerability          # CVE data model
│   ├── ScanResult             # Scan result container
│   ├── VulnerabilityScanner   # Abstract base class
│   ├── TrivyScanner           # Trivy integration
│   ├── GrypeScanner           # Grype integration
│   └── VulnerabilityManager   # High-level manager
├── vuln_report.py             # HTML/JSON report generation
└── vuln_monitor.py            # Scheduled scanning
```

## Severity Levels

| Level | CVSS Score | Action |
|-------|------------|--------|
| CRITICAL | 9.0 - 10.0 | Immediate action required |
| HIGH | 7.0 - 8.9 | Address within 24 hours |
| MEDIUM | 4.0 - 6.9 | Address within 7 days |
| LOW | 0.1 - 3.9 | Address in next maintenance window |

## Integration with CIS Benchmarks

The vulnerability scanner integrates with the CIS Benchmark scanner:

1. Run CIS compliance scan to harden configuration
2. Run vulnerability scan to detect CVEs
3. Address critical vulnerabilities first
4. Use auto-remediation for safe package upgrades

## Troubleshooting

### No scanner available

```
Error: No vulnerability scanner available
```

**Solution**: Install Trivy or Grype (see Prerequisites)

### Docker scan fails

```
Error: Docker scan failed: Cannot connect to Docker daemon
```

**Solution**: Ensure Docker is running and user has permissions:

```bash
sudo usermod -aG docker $USER
```

### Scan timeout

For large systems, increase timeout in scanner configuration or run scans during off-peak hours.
