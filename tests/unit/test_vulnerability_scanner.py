"""
Unit tests for Vulnerability Scanner
"""

from datetime import datetime
from unittest.mock import patch

from configurator.security.vulnerability_scanner import (
    GrypeScanner,
    ScanResult,
    TrivyScanner,
    Vulnerability,
    VulnerabilityManager,
    VulnerabilityScanner,
    VulnerabilitySeverity,
)


class TestVulnerability:
    """Tests for Vulnerability dataclass"""

    def test_vulnerability_creation(self):
        """Test basic vulnerability creation"""
        vuln = Vulnerability(
            cve_id="CVE-2024-1234",
            package_name="openssl",
            installed_version="1.1.1",
            fixed_version="1.1.2",
            severity=VulnerabilitySeverity.HIGH,
            cvss_score=8.5,
            description="Test vulnerability",
        )

        assert vuln.cve_id == "CVE-2024-1234"
        assert vuln.package_name == "openssl"
        assert vuln.severity == VulnerabilitySeverity.HIGH
        assert vuln.cvss_score == 8.5

    def test_vulnerability_to_dict(self):
        """Test vulnerability serialization"""
        vuln = Vulnerability(
            cve_id="CVE-2024-5678",
            package_name="curl",
            installed_version="7.74.0",
            fixed_version="7.75.0",
            severity=VulnerabilitySeverity.CRITICAL,
            cvss_score=9.8,
            description="Critical curl vulnerability",
        )

        d = vuln.to_dict()
        assert d["cve_id"] == "CVE-2024-5678"
        assert d["severity"] == "critical"
        assert d["cvss_score"] == 9.8

    def test_vulnerability_defaults(self):
        """Test default values"""
        vuln = Vulnerability(
            cve_id="CVE-2024-0001",
            package_name="test-pkg",
            installed_version="1.0",
            fixed_version=None,
            severity=VulnerabilitySeverity.UNKNOWN,
            cvss_score=None,
            description="Test",
        )

        assert vuln.exploit_available is False
        assert vuln.references == []
        assert vuln.target_type == "package"


class TestScanResult:
    """Tests for ScanResult dataclass"""

    def test_scan_result_creation(self):
        """Test basic scan result creation"""
        result = ScanResult(
            scan_id="test-123",
            scan_date=datetime.now(),
            scanner_name="Test",
            scanner_version="1.0",
            target="system",
            vulnerabilities=[],
            scan_duration_seconds=10.5,
        )

        assert result.scan_id == "test-123"
        assert result.target == "system"
        assert len(result.vulnerabilities) == 0

    def test_scan_result_get_summary(self):
        """Test summary generation"""
        vulns = [
            Vulnerability(
                cve_id="CVE-1",
                package_name="pkg1",
                installed_version="1.0",
                fixed_version="1.1",
                severity=VulnerabilitySeverity.CRITICAL,
                cvss_score=9.5,
                description="Critical",
            ),
            Vulnerability(
                cve_id="CVE-2",
                package_name="pkg2",
                installed_version="2.0",
                fixed_version=None,
                severity=VulnerabilitySeverity.HIGH,
                cvss_score=7.5,
                description="High",
            ),
            Vulnerability(
                cve_id="CVE-3",
                package_name="pkg3",
                installed_version="3.0",
                fixed_version="3.1",
                severity=VulnerabilitySeverity.MEDIUM,
                cvss_score=5.0,
                description="Medium",
            ),
        ]

        result = ScanResult(
            scan_id="test-456",
            scan_date=datetime.now(),
            scanner_name="Test",
            scanner_version="1.0",
            target="system",
            vulnerabilities=vulns,
            scan_duration_seconds=5.0,
        )

        summary = result.get_summary()
        assert summary["total"] == 3
        assert summary["by_severity"]["critical"] == 1
        assert summary["by_severity"]["high"] == 1
        assert summary["by_severity"]["medium"] == 1
        assert summary["fixable"] == 2  # CVE-1 and CVE-3 have fixes


class TestTrivyScanner:
    """Tests for TrivyScanner"""

    def test_trivy_scanner_is_vulnerability_scanner(self):
        """Test inheritance"""
        scanner = TrivyScanner()
        assert isinstance(scanner, VulnerabilityScanner)

    @patch("shutil.which")
    def test_is_available_when_installed(self, mock_which):
        """Test availability check when Trivy is installed"""
        mock_which.return_value = "/usr/bin/trivy"
        scanner = TrivyScanner()
        assert scanner.is_available() is True

    @patch("shutil.which")
    def test_is_available_when_not_installed(self, mock_which):
        """Test availability check when Trivy is not installed"""
        mock_which.return_value = None
        scanner = TrivyScanner()
        assert scanner.is_available() is False

    def test_parse_trivy_output_empty(self):
        """Test parsing empty Trivy output"""
        scanner = TrivyScanner()
        result = scanner._parse_trivy_output({"Results": []})
        assert len(result) == 0

    def test_parse_trivy_output_with_vulnerabilities(self):
        """Test parsing Trivy output with vulnerabilities"""
        scanner = TrivyScanner()
        trivy_data = {
            "Results": [
                {
                    "Vulnerabilities": [
                        {
                            "VulnerabilityID": "CVE-2024-TEST",
                            "PkgName": "test-package",
                            "InstalledVersion": "1.0.0",
                            "FixedVersion": "1.0.1",
                            "Severity": "HIGH",
                            "Description": "Test vulnerability",
                            "References": ["https://example.com"],
                        }
                    ]
                }
            ]
        }

        result = scanner._parse_trivy_output(trivy_data)
        assert len(result) == 1
        assert result[0].cve_id == "CVE-2024-TEST"
        assert result[0].severity == VulnerabilitySeverity.HIGH


class TestGrypeScanner:
    """Tests for GrypeScanner"""

    def test_grype_scanner_is_vulnerability_scanner(self):
        """Test inheritance"""
        scanner = GrypeScanner()
        assert isinstance(scanner, VulnerabilityScanner)

    def test_parse_grype_output_empty(self):
        """Test parsing empty Grype output"""
        scanner = GrypeScanner()
        result = scanner._parse_grype_output({"matches": []})
        assert len(result) == 0

    def test_parse_grype_output_with_vulnerabilities(self):
        """Test parsing Grype output with vulnerabilities"""
        scanner = GrypeScanner()
        grype_data = {
            "matches": [
                {
                    "vulnerability": {
                        "id": "CVE-2024-GRYPE",
                        "severity": "Critical",
                        "description": "Grype test vuln",
                        "fix": {"versions": ["2.0.0"]},
                        "urls": ["https://example.com"],
                    },
                    "artifact": {"name": "grype-test-pkg", "version": "1.0.0"},
                }
            ]
        }

        result = scanner._parse_grype_output(grype_data)
        assert len(result) == 1
        assert result[0].cve_id == "CVE-2024-GRYPE"
        assert result[0].severity == VulnerabilitySeverity.CRITICAL
        assert result[0].fixed_version == "2.0.0"


class TestVulnerabilityManager:
    """Tests for VulnerabilityManager"""

    def test_manager_initialization(self):
        """Test manager initialization"""
        manager = VulnerabilityManager()
        assert "trivy" in manager.scanners
        assert "grype" in manager.scanners

    @patch.object(TrivyScanner, "is_available", return_value=True)
    @patch.object(GrypeScanner, "is_available", return_value=False)
    def test_get_scanner_prefers_trivy(self, mock_grype, mock_trivy):
        """Test scanner preference"""
        manager = VulnerabilityManager(preferred_scanner="trivy")
        # Reinitialize available scanners
        manager.available_scanners = ["trivy"]
        scanner = manager.get_scanner()
        assert isinstance(scanner, TrivyScanner)

    def test_meets_threshold(self):
        """Test severity threshold checking"""
        manager = VulnerabilityManager()

        assert (
            manager._meets_threshold(VulnerabilitySeverity.CRITICAL, VulnerabilitySeverity.HIGH)
            is True
        )

        assert (
            manager._meets_threshold(VulnerabilitySeverity.MEDIUM, VulnerabilitySeverity.HIGH)
            is False
        )

        assert (
            manager._meets_threshold(VulnerabilitySeverity.HIGH, VulnerabilitySeverity.HIGH) is True
        )
