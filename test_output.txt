============================= test session starts ==============================
platform linux -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0 -- /usr/bin/python3
cachedir: .pytest_cache
rootdir: /home/racoon/AgentMemorh/debian-vps-workstation
configfile: pytest.ini (WARNING: ignoring pytest config in pyproject.toml!)
plugins: anyio-4.12.1, asyncio-1.3.0, cov-7.0.0, timeout-2.4.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 9 items

tests/security/test_phase5_script_security.py::TestCustomScriptSecurity::test_preview_script_static_analysis FAILED [ 11%]
tests/security/test_phase5_script_security.py::TestCustomScriptSecurity::test_preview_script_prevents_flag_injection PASSED [ 22%]
tests/security/test_phase5_script_security.py::TestCustomScriptSecurity::test_preview_script_execution_with_malicious_input PASSED [ 33%]
tests/security/test_phase5_script_security.py::TestCustomScriptSecurity::test_search_script_validates_pattern PASSED [ 44%]
tests/security/test_phase5_script_security.py::TestCustomScriptSecurity::test_goto_script_validates_directory PASSED [ 55%]
tests/security/test_phase5_script_security.py::TestPathManipulationSecurity::test_local_bin_added_to_path_safely PASSED [ 66%]
tests/security/test_phase5_script_security.py::TestPathManipulationSecurity::test_scripts_created_with_correct_ownership PASSED [ 77%]
tests/security/test_phase5_script_security.py::TestFZFPreviewSecurity::test_fzf_preview_uses_single_quotes PASSED [ 88%]
tests/security/test_phase5_script_security.py::TestFZFPreviewSecurity::test_fzf_preview_no_eval PASSED [100%]

=================================== FAILURES ===================================
_________ TestCustomScriptSecurity.test_preview_script_static_analysis _________
tests/security/test_phase5_script_security.py:77: in test_preview_script_static_analysis
    assert '[ -f' in script_content or '[ -d' in script_content or '[ -e' in script_content, \
E   AssertionError: Preview script doesn't validate file existence. Content: #!/bin/bash
E     # Intelligent search using ripgrep + fzf
E
E     if ! command -v rg &> /dev/null; then
E         echo...
E   assert ('[ -f' in '#!/bin/bash\n# Intelligent search using ripgrep + fzf\n\nif ! command -v rg &> /dev/null; then\n    echo "ripgrep (rg) not installed"\n    exit 1\nfi\n\nif ! command -v fzf &> /dev/null; then\n    echo "fzf not installed"\n    exit 1\nfi\n\n# Search pattern\nPATTERN="$1"\n\nif [ -z "$PATTERN" ]; then\n    echo "Usage: search <pattern>"\n    exit 1\nfi\n\n# Search and preview\n# Using -- to separate flags from pattern for safety\nrg --line-number --color=always --smart-case -- "$PATTERN" | \\\n    fzf --ansi \\\n        --delimiter : \\\n        --preview \'bat --color=always --highlight-line {2} -- {1}\' \\\n        --preview-window \'+{2}/2\' \\\n        --bind \'enter:execute(${EDITOR:-vim} +{2} -- {1})\'\n' or '[ -d' in '#!/bin/bash\n# Intelligent search using ripgrep + fzf\n\nif ! command -v rg &> /dev/null; then\n    echo "ripgrep (rg) not installed"\n    exit 1\nfi\n\nif ! command -v fzf &> /dev/null; then\n    echo "fzf not installed"\n    exit 1\nfi\n\n# Search pattern\nPATTERN="$1"\n\nif [ -z "$PATTERN" ]; then\n    echo "Usage: search <pattern>"\n    exit 1\nfi\n\n# Search and preview\n# Using -- to separate flags from pattern for safety\nrg --line-number --color=always --smart-case -- "$PATTERN" | \\\n    fzf --ansi \\\n        --delimiter : \\\n        --preview \'bat --color=always --highlight-line {2} -- {1}\' \\\n        --preview-window \'+{2}/2\' \\\n        --bind \'enter:execute(${EDITOR:-vim} +{2} -- {1})\'\n' or '[ -e' in '#!/bin/bash\n# Intelligent search using ripgrep + fzf\n\nif ! command -v rg &> /dev/null; then\n    echo "ripgrep (rg) not installed"\n    exit 1\nfi\n\nif ! command -v fzf &> /dev/null; then\n    echo "fzf not installed"\n    exit 1\nfi\n\n# Search pattern\nPATTERN="$1"\n\nif [ -z "$PATTERN" ]; then\n    echo "Usage: search <pattern>"\n    exit 1\nfi\n\n# Search and preview\n# Using -- to separate flags from pattern for safety\nrg --line-number --color=always --smart-case -- "$PATTERN" | \\\n    fzf --ansi \\\n        --delimiter : \\\n        --preview \'bat --color=always --highlight-line {2} -- {1}\' \\\n        --preview-window \'+{2}/2\' \\\n        --bind \'enter:execute(${EDITOR:-vim} +{2} -- {1})\'\n')
----------------------------- Captured stdout call -----------------------------
DEBUG: Script Content:
#!/bin/bash
# Universal file previewer
# Uses bat for text files, eza for directories

FILE="$1"

# Validate input
if [ -z "$FILE" ]; then
    echo "Usage: preview <file>"
    exit 1
fi

# Check file exists
if [ ! -e "$FILE" ]; then
    echo "File not found: $FILE"
    exit 1
fi

if [ -d "$FILE" ]; then
    # Directory:  use eza
    eza -lah --color=always --icons --git -- "$FILE"
elif [ -f "$FILE" ]; then
    # File: detect type and use appropriate tool
    MIME=$(file --mime-type -b -- "$FILE")

    case "$MIME" in
        text/*|application/json|application/xml)
            # Text file: use bat
            bat --color=always --style=numbers -- "$FILE"
            ;;
        image/*)
            # Image:  show info
            file -- "$FILE"
            ;;
        application/pdf)
            # PDF: show info
            pdfinfo -- "$FILE" 2>/dev/null || file -- "$FILE"
            ;;
        *)
            # Unknown:  show file info
            file -- "$FILE"
            ls -lh -- "$FILE"
            ;;
    esac
else
    echo "Not a file or directory: $FILE"
fi

DEBUG: Script Content:
#!/bin/bash
# Intelligent search using ripgrep + fzf

if ! command -v rg &> /dev/null; then
    echo "ripgrep (rg) not installed"
    exit 1
fi

if ! command -v fzf &> /dev/null; then
    echo "fzf not installed"
    exit 1
fi

# Search pattern
PATTERN="$1"

if [ -z "$PATTERN" ]; then
    echo "Usage: search <pattern>"
    exit 1
fi

# Search and preview
# Using -- to separate flags from pattern for safety
rg --line-number --color=always --smart-case -- "$PATTERN" | \
    fzf --ansi \
        --delimiter : \
        --preview 'bat --color=always --highlight-line {2} -- {1}' \
        --preview-window '+{2}/2' \
        --bind 'enter:execute(${EDITOR:-vim} +{2} -- {1})'

=========================== short test summary info ============================
FAILED tests/security/test_phase5_script_security.py::TestCustomScriptSecurity::test_preview_script_static_analysis - AssertionError: Preview script doesn't validate file existence. Content: #!/bin/bash
  # Intelligent search using ripgrep + fzf

  if ! command -v rg &> /dev/null; then
      echo...
assert ('[ -f' in '#!/bin/bash\n# Intelligent search using ripgrep + fzf\n\nif ! command -v rg &> /dev/null; then\n    echo "ripgrep (rg) not installed"\n    exit 1\nfi\n\nif ! command -v fzf &> /dev/null; then\n    echo "fzf not installed"\n    exit 1\nfi\n\n# Search pattern\nPATTERN="$1"\n\nif [ -z "$PATTERN" ]; then\n    echo "Usage: search <pattern>"\n    exit 1\nfi\n\n# Search and preview\n# Using -- to separate flags from pattern for safety\nrg --line-number --color=always --smart-case -- "$PATTERN" | \\\n    fzf --ansi \\\n        --delimiter : \\\n        --preview \'bat --color=always --highlight-line {2} -- {1}\' \\\n        --preview-window \'+{2}/2\' \\\n        --bind \'enter:execute(${EDITOR:-vim} +{2} -- {1})\'\n' or '[ -d' in '#!/bin/bash\n# Intelligent search using ripgrep + fzf\n\nif ! command -v rg &> /dev/null; then\n    echo "ripgrep (rg) not installed"\n    exit 1\nfi\n\nif ! command -v fzf &> /dev/null; then\n    echo "fzf not installed"\n    exit 1\nfi\n\n# Search pattern\nPATTERN="$1"\n\nif [ -z "$PATTERN" ]; then\n    echo "Usage: search <pattern>"\n    exit 1\nfi\n\n# Search and preview\n# Using -- to separate flags from pattern for safety\nrg --line-number --color=always --smart-case -- "$PATTERN" | \\\n    fzf --ansi \\\n        --delimiter : \\\n        --preview \'bat --color=always --highlight-line {2} -- {1}\' \\\n        --preview-window \'+{2}/2\' \\\n        --bind \'enter:execute(${EDITOR:-vim} +{2} -- {1})\'\n' or '[ -e' in '#!/bin/bash\n# Intelligent search using ripgrep + fzf\n\nif ! command -v rg &> /dev/null; then\n    echo "ripgrep (rg) not installed"\n    exit 1\nfi\n\nif ! command -v fzf &> /dev/null; then\n    echo "fzf not installed"\n    exit 1\nfi\n\n# Search pattern\nPATTERN="$1"\n\nif [ -z "$PATTERN" ]; then\n    echo "Usage: search <pattern>"\n    exit 1\nfi\n\n# Search and preview\n# Using -- to separate flags from pattern for safety\nrg --line-number --color=always --smart-case -- "$PATTERN" | \\\n    fzf --ansi \\\n        --delimiter : \\\n        --preview \'bat --color=always --highlight-line {2} -- {1}\' \\\n        --preview-window \'+{2}/2\' \\\n        --bind \'enter:execute(${EDITOR:-vim} +{2} -- {1})\'\n')
========================= 1 failed, 8 passed in 0.27s ==========================
